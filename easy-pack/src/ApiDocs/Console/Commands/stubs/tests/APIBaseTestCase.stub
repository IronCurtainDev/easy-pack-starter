<?php

namespace Tests\Feature\AutoGen\API;

use Tests\TestCase;
use App\Models\User;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Illuminate\Foundation\Testing\WithFaker;
use Laravel\Sanctum\Sanctum;

/**
 * Base Test Case for auto-generated API tests
 *
 * This class provides common functionality for all API tests.
 * Do not edit this file directly - it will be overwritten when tests are regenerated.
 *
 * @package Tests\Feature\AutoGen\API
 */
abstract class APIBaseTestCase extends TestCase
{
    use RefreshDatabase, WithFaker;

    /**
     * The authenticated user for tests
     *
     * @var User|null
     */
    protected ?User $user = null;

    /**
     * The API base path
     *
     * @var string
     */
    protected string $apiBasePath = '/api/v1';

    /**
     * Default headers for API requests
     *
     * @var array
     */
    protected array $defaultHeaders = [
        'Accept' => 'application/json',
        'Content-Type' => 'application/json',
    ];

    /**
     * Set up the test environment
     */
    protected function setUp(): void
    {
        parent::setUp();

        // Create and authenticate a user
        $this->user = User::factory()->create();
        Sanctum::actingAs($this->user);

        // Add API key header if configured
        if ($apiKey = config('app.key')) {
            $this->defaultHeaders['x-api-key'] = $apiKey;
        }
    }

    /**
     * Make an authenticated API request
     *
     * @param string $method HTTP method
     * @param string $uri URI path (will be prefixed with apiBasePath)
     * @param array $data Request data
     * @param array $headers Additional headers
     * @return \Illuminate\Testing\TestResponse
     */
    protected function apiRequest(string $method, string $uri, array $data = [], array $headers = [])
    {
        $fullUri = $this->apiBasePath . $uri;
        $allHeaders = array_merge($this->defaultHeaders, $headers);

        return $this->withHeaders($allHeaders)->json($method, $fullUri, $data);
    }

    /**
     * Make a GET request to the API
     *
     * @param string $uri
     * @param array $queryParams
     * @param array $headers
     * @return \Illuminate\Testing\TestResponse
     */
    protected function apiGet(string $uri, array $queryParams = [], array $headers = [])
    {
        if (!empty($queryParams)) {
            $uri .= '?' . http_build_query($queryParams);
        }

        return $this->apiRequest('GET', $uri, [], $headers);
    }

    /**
     * Make a POST request to the API
     *
     * @param string $uri
     * @param array $data
     * @param array $headers
     * @return \Illuminate\Testing\TestResponse
     */
    protected function apiPost(string $uri, array $data = [], array $headers = [])
    {
        return $this->apiRequest('POST', $uri, $data, $headers);
    }

    /**
     * Make a PUT request to the API
     *
     * @param string $uri
     * @param array $data
     * @param array $headers
     * @return \Illuminate\Testing\TestResponse
     */
    protected function apiPut(string $uri, array $data = [], array $headers = [])
    {
        return $this->apiRequest('PUT', $uri, $data, $headers);
    }

    /**
     * Make a PATCH request to the API
     *
     * @param string $uri
     * @param array $data
     * @param array $headers
     * @return \Illuminate\Testing\TestResponse
     */
    protected function apiPatch(string $uri, array $data = [], array $headers = [])
    {
        return $this->apiRequest('PATCH', $uri, $data, $headers);
    }

    /**
     * Make a DELETE request to the API
     *
     * @param string $uri
     * @param array $data
     * @param array $headers
     * @return \Illuminate\Testing\TestResponse
     */
    protected function apiDelete(string $uri, array $data = [], array $headers = [])
    {
        return $this->apiRequest('DELETE', $uri, $data, $headers);
    }

    /**
     * Assert that the response is a successful API response
     *
     * @param \Illuminate\Testing\TestResponse $response
     * @param int $statusCode Expected status code (default 200)
     * @return void
     */
    protected function assertApiSuccess($response, int $statusCode = 200): void
    {
        $response->assertStatus($statusCode);
        $response->assertHeader('Content-Type', 'application/json');
    }

    /**
     * Assert that the response is an API error
     *
     * @param \Illuminate\Testing\TestResponse $response
     * @param int $statusCode Expected status code
     * @return void
     */
    protected function assertApiError($response, int $statusCode): void
    {
        $response->assertStatus($statusCode);
        $response->assertJsonStructure(['message']);
    }

    /**
     * Assert that the response is a validation error
     *
     * @param \Illuminate\Testing\TestResponse $response
     * @return void
     */
    protected function assertValidationError($response): void
    {
        $response->assertStatus(422);
        $response->assertJsonStructure(['message', 'errors']);
    }

    /**
     * Assert that the response is unauthorized
     *
     * @param \Illuminate\Testing\TestResponse $response
     * @return void
     */
    protected function assertUnauthorized($response): void
    {
        $response->assertStatus(401);
    }

    /**
     * Assert that the response is forbidden
     *
     * @param \Illuminate\Testing\TestResponse $response
     * @return void
     */
    protected function assertForbidden($response): void
    {
        $response->assertStatus(403);
    }

    /**
     * Assert that the response is not found
     *
     * @param \Illuminate\Testing\TestResponse $response
     * @return void
     */
    protected function assertNotFound($response): void
    {
        $response->assertStatus(404);
    }

    /**
     * Save response to a JSON file for documentation
     *
     * @param \Illuminate\Testing\TestResponse $response
     * @param string $filename
     * @return void
     */
    protected function saveResponseToFile($response, string $filename): void
    {
        $dirPath = resource_path('docs/api_responses/auto_generated');
        if (!is_dir($dirPath)) {
            mkdir($dirPath, 0755, true);
        }

        $filePath = $dirPath . DIRECTORY_SEPARATOR . $filename . '.json';
        file_put_contents($filePath, json_encode($response->json(), JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES));
    }

    /**
     * Get a sample value for a parameter type
     *
     * @param string $type
     * @param string $name
     * @return mixed
     */
    protected function getSampleValue(string $type, string $name = ''): mixed
    {
        return match (strtolower($type)) {
            'string' => $this->getSampleStringValue($name),
            'integer', 'int', 'number' => $this->faker->numberBetween(1, 100),
            'boolean', 'bool' => $this->faker->boolean,
            'email' => $this->faker->email,
            'date' => $this->faker->date(),
            'datetime' => $this->faker->dateTime->format('Y-m-d H:i:s'),
            'array' => [],
            'file' => null,
            default => $this->faker->word,
        };
    }

    /**
     * Get a sample string value based on the parameter name
     *
     * @param string $name
     * @return string
     */
    protected function getSampleStringValue(string $name): string
    {
        $name = strtolower($name);

        return match (true) {
            str_contains($name, 'email') => $this->faker->email,
            str_contains($name, 'name') => $this->faker->name,
            str_contains($name, 'phone') => $this->faker->phoneNumber,
            str_contains($name, 'address') => $this->faker->address,
            str_contains($name, 'city') => $this->faker->city,
            str_contains($name, 'country') => $this->faker->country,
            str_contains($name, 'url') || str_contains($name, 'link') => $this->faker->url,
            str_contains($name, 'description') || str_contains($name, 'bio') => $this->faker->paragraph,
            str_contains($name, 'title') => $this->faker->sentence,
            str_contains($name, 'password') => 'Password123!',
            str_contains($name, 'uuid') => $this->faker->uuid,
            default => $this->faker->word,
        };
    }
}
